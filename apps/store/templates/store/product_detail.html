{% extends 'index.html' %}
{% load static %}

{% block content %}

<div class="row product-detail-row">
    <div class="col-md-6 mb-4 mb-md-0">
        <img src="{{product.imageURL}}" class="img-fluid rounded product-detail-img" alt="{{product.name}}">
    </div>
    <div class="col-md-6 product-detail-content">
        <h2 class="product-detail-title">{{product.name}}</h2>
        {% if product.category %}
        <p><span class="badge bg-secondary">{{product.category}}</span></p>
        {% endif %}
        <h3 class="product-detail-price"><img src="{% static 'images/rupee.svg' %}" style="width: 20px;"/> {{product.price|floatformat:2}}</h3>
        
        <div class="mt-3 product-detail-desc">{{product.description|safe|default:"No description available."}}</div>
        
        <div class="mt-4">
            {% if product.in_stock %}
                <p class="text-success">In Stock: {{product.stock}} available</p>
                <button data-product={{product.id}} data-action="add" class="btn btn-primary btn-lg update-cart product-detail-btn">Add to Cart</button>
                {% if user.is_authenticated %}
                <button onclick="toggleWishlist({{product.id}})" class="btn btn-outline-danger btn-lg ms-2" id="wishlist-btn">
                    <i class="bi bi-heart"></i> Wishlist
                </button>
                {% endif %}
            {% else %}
                <p class="text-danger">Out of Stock</p>
                <button class="btn btn-secondary btn-lg product-detail-btn" disabled>Out of Stock</button>
            {% endif %}
        </div>
        
        <div class="mt-3">
            <a href="{% url 'store' %}" class="btn btn-outline-secondary">Back to Store</a>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="row mt-5">
    <div class="col-12">
        <h3>Customer Reviews</h3>
        {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-body">
                <h5>Write a Review</h5>
                <form id="review-form">
                    <div class="mb-3">
                        <label>Rating:</label>
                        <select id="rating" class="form-select" required>
                            <option value="">Select Rating</option>
                            <option value="5">5 Stars - Excellent</option>
                            <option value="4">4 Stars - Good</option>
                            <option value="3">3 Stars - Average</option>
                            <option value="2">2 Stars - Poor</option>
                            <option value="1">1 Star - Terrible</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Comment:</label>
                        <textarea id="comment" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>
        </div>
        {% else %}
        <p><a href="{% url 'login' %}">Login</a> to write a review</p>
        {% endif %}
        
        <div id="reviews-list">
            <!-- Reviews will be loaded here -->
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleWishlist(productId) {
    fetch('/api/toggle-wishlist/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({product_id: productId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById('wishlist-btn');
            if (data.action === 'added') {
                btn.innerHTML = '<i class="bi bi-heart-fill"></i> In Wishlist';
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-danger');
            } else {
                btn.innerHTML = '<i class="bi bi-heart"></i> Wishlist';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-danger');
            }
        }
    });
}

document.getElementById('review-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const rating = document.getElementById('rating').value;
    const comment = document.getElementById('comment').value;
    
    fetch('/api/add-review/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: {{product.id}},
            rating: rating,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Review submitted successfully!');
            document.getElementById('review-form').reset();
        } else {
            alert('Error: ' + data.error);
        }
    });
});
</script>

<style>
.product-detail-content {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
}

.product-detail-title {
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: auto;
}

.product-detail-desc {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
}

.product-detail-desc * {
    max-width: 100% !important;
    overflow-wrap: break-word !important;
    word-wrap: break-word !important;
}

.product-detail-desc table {
    width: 100% !important;
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.product-detail-desc img {
    max-width: 100% !important;
    height: auto !important;
}

@media (max-width: 768px) {
    .product-detail-row {
        margin: 0;
    }
    
    .product-detail-content {
        padding: 0 0.5rem;
    }
    
    .product-detail-title {
        font-size: 1.25rem;
        line-height: 1.3;
        margin-bottom: 0.75rem;
    }
    
    .product-detail-price {
        font-size: 1.35rem;
    }
    
    .product-detail-desc {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .product-detail-desc p {
        margin-bottom: 0.75rem;
    }
    
    .product-detail-desc ul,
    .product-detail-desc ol {
        padding-left: 1.25rem;
    }
    
    .product-detail-btn {
        width: 100%;
        font-size: 0.95rem;
        padding: 0.7rem;
        margin-bottom: 0.5rem;
    }
    
    .product-detail-img {
        max-height: 280px;
        object-fit: contain;
        width: 100%;
    }
}

@media (max-width: 576px) {
    .product-detail-content {
        padding: 0 0.25rem;
    }
    
    .product-detail-title {
        font-size: 1.1rem;
        line-height: 1.25;
    }
    
    .product-detail-price {
        font-size: 1.2rem;
    }
    
    .product-detail-desc {
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    .product-detail-img {
        max-height: 240px;
    }
}
</style>

{% endblock content %}
